
# First, throw away spam
if (/^X-Spam-Flag: *YES$/)
{
    to $DEFAULT/.Junk/
}

# Next handle bounces from Spa Staff (I get a bunch)
if (hasaddr "no-reply@spastaff.com")
{
    # If they are from one of my mail servers, they are a bounce that
    # I'll care about
    if (/^From:.*@(sendgrid\.net|lucy\.sweeb\.net|.*\.authsmtp.com)/)
    {
        to $DEFAULT/.Bounces/
    }
    else
    {
        # If they are from another server, it's normally an auto reply
        # or something similarly uninteresting
        to $DEFAULT/.Junk/
    }
}

# Mailing list automagic
# Adapted From https://github.com/hrw/dotfiles-mailfilter
#
if (/^List-Id:.*<([0-9A-Za-z_\-]+)\.(list[sy]\.)?(.*)>/)
{
    LISTNAME=tolower($MATCH1)

    # get rid of /.ML..
    if ($LISTNAME)
    {
        # do not create toplevel folder for each github project
        if (/^List-Id:.*github.com>/)
        {
            LISTDOMAIN="github-com"
        }
        else
        {
            # convert server name from dots to hyphens
            foreach ($MATCH3) =~ /[^.]+/
            { 
                LISTDOMAIN="${LISTDOMAIN}-${MATCH}"
            }
            LISTDOMAIN=substr($LISTDOMAIN, 1)
        }

        DESTDIR="$DEFAULT/.ML.$LISTDOMAIN.$LISTNAME"
        DESTDOMAINDIR="$DEFAULT/.ML.$LISTDOMAIN"

        `test -d $DESTDIR`
        if ($RETURNCODE == 1)
        {
            `test -d $DESTDOMAINDIR`
            if ($RETURNCODE == 1)
            {
                `maildirmake -f ML.$LISTDOMAIN  $DEFAULT`
            }

            `maildirmake -f ML.$LISTDOMAIN.$LISTNAME $DEFAULT`
        }
        
        to $DESTDIR
    }
}

to $DEFAULT
